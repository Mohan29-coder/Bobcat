<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Affiliate — StakeVault</title>
    <style>
         :root {
            --primary: #1e90ff;
            --muted: #6b7280
        }
        
        body {
            font-family: Poppins, system-ui, Segoe UI, Roboto;
            margin: 24px;
            background: #f4f7fb;
            color: #0f172a
        }
        
        .card {
            max-width: 920px;
            margin: 0 auto;
            padding: 18px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(2, 6, 23, .06)
        }
        
        h1 {
            margin: 0 0 6px
        }
        
        .muted {
            color: var(--muted)
        }
        
        .row {
            display: flex;
            gap: 12px;
            align-items: center
        }
        
        input[type=text] {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e6edf8
        }
        
        button {
            padding: 10px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600
        }
        
        .btn-primary {
            background: var(--primary);
            color: #fff
        }
        
        .btn-ghost {
            background: #fff;
            border: 1px solid rgba(30, 144, 255, .12);
            color: var(--primary)
        }
        
        .section {
            margin-top: 14px
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px
        }
        
        th,
        td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: left
        }
        
        .qr {
            width: 140px;
            height: 140px;
            border-radius: 8px;
            border: 1px solid #eef6ff;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center
        }
        
        .small {
            font-size: 13px;
            color: var(--muted)
        }
        
        @media(max-width:720px) {
            .row {
                flex-direction: column;
                align-items: stretch
            }
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>Affiliate Program</h1>
        <div class="small muted">Share your referral link — earn rewards when your referrals register and deposit.</div>

        <div id="notLogged" class="section" style="display:none">
            <p class="muted">You must be logged in to access affiliate tools.</p>
            <div style="display:flex;gap:8px">
                <button class="btn-primary" id="goRegister">Register</button>
                <button class="btn-ghost" id="goLogin">Login</button>
            </div>
        </div>

        <div id="content" style="display:none">
            <div class="section">
                <label><strong>Your affiliate link</strong></label>
                <div class="row" style="margin-top:8px">
                    <input id="affLink" type="text" readonly />
                    <button class="btn-primary" id="copyBtn">Copy</button>
                    <button class="btn-ghost" id="shareBtn">Share</button>
                </div>
                <div class="small section">Tip: Add ?ref=AFFCODE to your promotional links or share via social buttons below.</div>
            </div>

            <div class="section row" style="align-items:flex-start">
                <div style="flex:1">
                    <h3 style="margin:0 0 8px">Quick share</h3>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button id="tw" class="btn-ghost">Share on Twitter</button>
                        <button id="tg" class="btn-ghost">Share on Telegram</button>
                        <button id="wa" class="btn-ghost">WhatsApp</button>
                        <button id="copyMsg" class="btn-ghost">Copy Promo Message</button>
                    </div>

                    <div class="section">
                        <h4 style="margin:0 0 8px">Promo message</h4>
                        <textarea id="promo" style="width:100%;min-height:80px;padding:10px;border-radius:8px;border:1px solid #eef6ff">Join me on StakeVault — deposit USDT, stake and earn daily rewards. Register with my link: {link}</textarea>
                    </div>
                </div>

                <div style="width:160px;text-align:center">
                    <h4 style="margin:0 0 8px">QR</h4>
                    <div class="qr" id="qrWrap"><img id="qrImg" alt="QR" style="max-width:100%;border-radius:6px"></div>
                    <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
                        <button id="dlQr" class="btn-ghost">Download</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 style="margin:0 0 6px">Referrals</h3>
                <div class="small muted" id="statsLine">Total referrals: 0 • Referred deposits: 0</div>

                <table id="refTable" class="section">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Registered</th>
                            <th>Deposited?</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Minimal affiliate page logic (client-side demo)
        const goRegister = document.getElementById('goRegister');
        const goLogin = document.getElementById('goLogin');
        if (goRegister) goRegister.addEventListener('click', () => location.href = 'register.html');
        if (goLogin) goLogin.addEventListener('click', () => location.href = 'login.html');

        const logged = localStorage.getItem('loggedUser');
        const notLoggedEl = document.getElementById('notLogged');
        const contentEl = document.getElementById('content');

        if (!logged) {
            notLoggedEl.style.display = 'block';
            contentEl.style.display = 'none';
        } else {
            notLoggedEl.style.display = 'none';
            contentEl.style.display = 'block';
            initAffiliate(logged);
        }

        function genAffiliateCode() {
            return 'AFF-' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6).toUpperCase();
        }

        function initAffiliate(username) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            let me = users.find(u => u.username === username);

            // create user record if not present (defensive)
            if (!me) {
                me = {
                    username,
                    password: '',
                    affiliateCode: genAffiliateCode(),
                    createdAt: new Date().toISOString()
                };
                users.push(me);
                localStorage.setItem('users', JSON.stringify(users));
            }

            if (!me.affiliateCode) {
                me.affiliateCode = genAffiliateCode();
                // persist
                const idx = users.findIndex(x => x.username === me.username);
                if (idx !== -1) {
                    users[idx] = me;
                    localStorage.setItem('users', JSON.stringify(users));
                }
            }

            const origin = location.origin || (location.protocol + '//' + location.host);
            const link = origin + '/index.html?ref=' + encodeURIComponent(me.affiliateCode);
            document.getElementById('affLink').value = link;

            // build promo message
            const promoEl = document.getElementById('promo');
            promoEl.value = promoEl.value.replace('{link}', link);

            // QR via Google Chart API (quick, public demo)
            const qrUrl = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(link);
            document.getElementById('qrImg').src = qrUrl;

            // share/copy handlers
            document.getElementById('copyBtn').addEventListener('click', async() => {
                try {
                    await navigator.clipboard.writeText(link);
                    alert('Link copied to clipboard.');
                } catch (e) {
                    alert('Copy failed. Select and copy manually.');
                }
            });

            document.getElementById('shareBtn').addEventListener('click', async() => {
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Join StakeVault',
                            text: 'Join me on StakeVault',
                            url: link
                        });
                    } catch (e) {}
                } else {
                    alert('Share not available on this browser. Use copy or social buttons.');
                }
            });

            // social
            const tw = document.getElementById('tw');
            const tg = document.getElementById('tg');
            const wa = document.getElementById('wa');
            const copyMsgBtn = document.getElementById('copyMsg');
            const dlQr = document.getElementById('dlQr');

            if (tw) tw.addEventListener('click', () => {
                const text = encodeURIComponent('Join me on StakeVault — earn daily USDT rewards. ');
                window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(link)}`, '_blank');
            });
            if (tg) tg.addEventListener('click', () => {
                window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent('Join me on StakeVault!')}`, '_blank');
            });
            if (wa) wa.addEventListener('click', () => {
                window.open(`https://wa.me/?text=${encodeURIComponent('Join StakeVault: ' + link)}`, '_blank');
            });
            if (copyMsgBtn) copyMsgBtn.addEventListener('click', async() => {
                try {
                    await navigator.clipboard.writeText(promoEl.value);
                    alert('Promo message copied.');
                } catch (e) {
                    alert('Copy failed.');
                }
            });

            // download QR
            if (dlQr) dlQr.addEventListener('click', () => {
                const url = qrUrl;
                const a = document.createElement('a');
                a.href = url;
                a.download = 'affiliate-qr.png';
                document.body.appendChild(a);
                a.click();
                a.remove();
            });

            // referrals table
            const referrals = users.filter(u => u.referredBy === me.affiliateCode);
            renderReferrals(referrals);
        }

        function renderReferrals(list) {
            const tbody = document.querySelector('#refTable tbody');
            tbody.innerHTML = '';
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="muted">No referrals yet.</td></tr>';
            } else {
                list.forEach(r => {
                    const deposited = hasMadeDeposit(r.username) ? 'Yes' : 'No';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${r.username}</td><td>${new Date(r.createdAt||r.date||'').toLocaleString()}</td><td>${deposited}</td>`;
                    tbody.appendChild(tr);
                });
            }
            const statsLine = document.getElementById('statsLine');
            const depositedCount = list.reduce((s, u) => s + (hasMadeDeposit(u.username) ? 1 : 0), 0);
            if (statsLine) statsLine.innerText = `Total referrals: ${list.length} • Referred deposits: ${depositedCount}`;
        }

        // detection if referred user made deposits — search transactions by username if stored
        function hasMadeDeposit(username) {
            // transactions are stored in localStorage 'transactions' — we don't tie tx to username in core demo.
            // If you record tx owner in meta.username, check that. Otherwise best-effort: check users[].balance > 0
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const u = users.find(x => x.username === username);
            if (!u) return false;
            // check stored balances keyed by username? If your app uses shared 'balance' only, this will be false.
            // For demo: consider a property u.balance
            return !!(u.balance && parseFloat(u.balance) > 0);
        }
    </script>
</body>

</html>
